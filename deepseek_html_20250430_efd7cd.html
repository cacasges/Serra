<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serra Intelligente | Belpasso</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #2E7D32;
            --primary-light: #60AD5E;
            --primary-dark: #1B5E20;
            --secondary: #FFC107;
            --secondary-dark: #FFA000;
            --background: #F5F7FA;
            --surface: #FFFFFF;
            --error: #D32F2F;
            --on-primary: #FFFFFF;
            --on-secondary: #212121;
            --on-surface: #212121;
            --on-background: #212121;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background);
            color: var(--on-background);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background-color: var(--primary);
            color: var(--on-primary);
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            font-size: 2.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .logo-text h1 {
            font-weight: 500;
            margin: 0;
            font-size: 1.8rem;
        }

        .logo-text p {
            margin: 0;
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .telegram-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: var(--secondary);
            color: var(--on-secondary);
            padding: 10px 20px;
            border-radius: 24px;
            text-decoration: none;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .telegram-btn:hover {
            background-color: var(--secondary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--primary);
            margin: 0;
        }

        .card-title .material-icons-round {
            font-size: 1.4rem;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-ok {
            background-color: #E8F5E9;
            color: var(--primary);
        }

        .status-warning {
            background-color: #FFF8E1;
            color: #F57C00;
        }

        .status-danger {
            background-color: #FFEBEE;
            color: var(--error);
        }

        /* Sensor Grid */
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .sensor-item {
            text-align: center;
            padding: 15px;
            border-radius: 12px;
            background: rgba(0,0,0,0.02);
            transition: all 0.3s ease;
        }

        .sensor-item:hover {
            background: rgba(46, 125, 50, 0.05);
            transform: translateY(-3px);
        }

        .sensor-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--primary);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
            100% { transform: translateY(0px); }
        }

        .sensor-value {
            font-size: 1.8rem;
            font-weight: 300;
            margin: 5px 0;
        }

        .sensor-unit {
            font-size: 0.9rem;
            color: #757575;
        }

        .sensor-label {
            font-size: 0.9rem;
            color: #616161;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
            margin-top: 20px;
        }

        /* Weather Card */
        .weather-card {
            display: flex;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #64B5F6 0%, #42A5F5 100%);
            color: white;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .weather-icon {
            font-size: 3.5rem;
            margin-right: 25px;
            animation: wobble 5s ease-in-out infinite;
        }

        @keyframes wobble {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(3deg); }
            75% { transform: rotate(-3deg); }
        }

        .weather-details {
            flex-grow: 1;
        }

        .weather-temp {
            font-size: 2.8rem;
            font-weight: 300;
            margin: 0;
            line-height: 1;
        }

        .weather-desc {
            margin: 5px 0;
            font-weight: 500;
            font-size: 1.1rem;
        }

        .weather-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .weather-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        /* Forecast */
        .hourly-forecast {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 15px 0;
            scrollbar-width: thin;
        }

        .hourly-item {
            min-width: 90px;
            text-align: center;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(5px);
            border-radius: 12px;
            padding: 15px 10px;
            transition: all 0.3s ease;
        }

        .hourly-item:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .daily-forecast {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .daily-item {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .daily-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* Plant Status */
        .plant-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 20px 0;
        }

        .plant-icon {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }

        .plant-name {
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .plant-variety {
            color: #757575;
            margin-bottom: 15px;
        }

        .plant-health {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .health-icon {
            font-size: 1.5rem;
        }

        .health-ok {
            color: var(--primary);
        }

        .health-warning {
            color: #FFA000;
        }

        .health-danger {
            color: var(--error);
        }

        /* Issues List */
        .issues-list {
            margin-top: 20px;
        }

        .issue-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 15px;
            background: #FFF3E0;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .issue-icon {
            color: #FFA000;
            font-size: 1.2rem;
        }

        /* Controls */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .control-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--surface);
            border: none;
            padding: 20px 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .control-btn:hover {
            background: rgba(46, 125, 50, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .control-btn.active {
            background: var(--primary);
            color: var(--on-primary);
        }

        .control-btn.active .control-icon {
            color: var(--on-primary);
        }

        .control-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary);
            transition: all 0.3s ease;
        }

        .control-label {
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Action Log */
        .action-log {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .log-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .log-time {
            min-width: 70px;
            font-size: 0.8rem;
            color: #757575;
        }

        .log-icon {
            font-size: 1.2rem;
            margin-right: 15px;
            color: var(--primary);
        }

        .log-water {
            color: #2196F3;
        }

        .log-fan {
            color: #4CAF50;
        }

        .log-light {
            color: #FFC107;
        }

        .log-message {
            flex-grow: 1;
        }

        /* Chatbot */
        .chatbot-container {
            grid-column: 1 / -1;
            background: var(--surface);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .chatbot-header {
            display: flex;
            align-items: center;
            padding: 20px;
            background: var(--primary);
            color: var(--on-primary);
        }

        .chatbot-icon {
            font-size: 1.8rem;
            margin-right: 15px;
            animation: pulse 2s infinite;
        }

        .chatbot-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin: 0;
        }

        .chatbot-messages {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #FAFAFA;
        }

        .message {
            margin-bottom: 15px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bot-message {
            align-self: flex-start;
            background: #E8F5E9;
            border-radius: 18px 18px 18px 4px;
            padding: 12px 16px;
            margin-right: auto;
        }

        .user-message {
            align-self: flex-end;
            background: var(--primary);
            color: var(--on-primary);
            border-radius: 18px 18px 4px 18px;
            padding: 12px 16px;
            margin-left: auto;
        }

        .chatbot-input {
            display: flex;
            padding: 15px;
            background: var(--surface);
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .chatbot-input input {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 24px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .chatbot-input input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }

        .chatbot-input button {
            background: var(--primary);
            color: var(--on-primary);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chatbot-input button:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        /* Plant Selection */
        .plant-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .plant-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            background: var(--surface);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
        }

        .plant-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .plant-option.selected {
            background: rgba(46, 125, 50, 0.1);
            border: 2px solid var(--primary);
        }

        .plant-option-icon {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .logo {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <span class="material-icons-round logo-icon">spa</span>
                <div class="logo-text">
                    <h1>Serra Intelligente</h1>
                    <p>Belpasso, CT | Monitoraggio in tempo reale</p>
                </div>
            </div>
            <a href="https://t.me/serrautobot" class="telegram-btn" target="_blank">
                <span class="material-icons-round">send</span>
                Collegati al Bot
            </a>
        </div>
    </header>

    <div class="container">
        <div class="dashboard">
            <!-- Ambiente Interno -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="material-icons-round">home</span>
                        Ambiente Interno
                    </h2>
                    <span id="internal-status" class="status-badge status-ok">Ottimale</span>
                </div>
                
                <div class="sensor-grid">
                    <div class="sensor-item">
                        <span class="material-icons-round sensor-icon">thermostat</span>
                        <div class="sensor-value" id="internal-temp">24.5</div>
                        <div class="sensor-unit">¬∞C</div>
                        <div class="sensor-label">Temperatura</div>
                    </div>
                    
                    <div class="sensor-item">
                        <span class="material-icons-round sensor-icon">water_drop</span>
                        <div class="sensor-value" id="internal-humidity">65</div>
                        <div class="sensor-unit">%</div>
                        <div class="sensor-label">Umidit√†</div>
                    </div>
                    
                    <div class="sensor-item">
                        <span class="material-icons-round sensor-icon">grass</span>
                        <div class="sensor-value" id="internal-soil">72</div>
                        <div class="sensor-unit">%</div>
                        <div class="sensor-label">Terreno</div>
                    </div>
                    
                    <div class="sensor-item">
                        <span class="material-icons-round sensor-icon">light_mode</span>
                        <div class="sensor-value" id="internal-light">8500</div>
                        <div class="sensor-unit">lux</div>
                        <div class="sensor-label">Luminosit√†</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="internal-chart"></canvas>
                </div>
            </div>
            
            <!-- Meteo Esterno -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="material-icons-round">wb_sunny</span>
                        Meteo Esterno
                    </h2>
                    <span id="external-status" class="status-badge status-ok">Sereno</span>
                </div>
                
                <div class="weather-card">
                    <span class="material-icons-round weather-icon">wb_sunny</span>
                    <div class="weather-details">
                        <h3 class="weather-temp" id="current-temp">28¬∞C</h3>
                        <p class="weather-desc" id="weather-desc">Sereno</p>
                        <div class="weather-meta">
                            <span class="weather-meta-item">
                                <span class="material-icons-round">water_drop</span>
                                <span id="weather-humidity">42%</span>
                            </span>
                            <span class="weather-meta-item">
                                <span class="material-icons-round">air</span>
                                <span id="weather-wind">12 km/h</span>
                            </span>
                            <span class="weather-meta-item">
                                <span class="material-icons-round">umbrella</span>
                                <span id="weather-rain">0 mm</span>
                            </span>
                        </div>
                    </div>
                </div>
                
                <h4>Prossime ore</h4>
                <div class="hourly-forecast" id="hourly-forecast">
                    <!-- Popolato via JavaScript -->
                </div>
                
                <h4>Prossimi giorni</h4>
                <div class="daily-forecast" id="daily-forecast">
                    <!-- Popolato via JavaScript -->
                </div>
            </div>
            
            <!-- Stato Pianta -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="material-icons-round">local_florist</span>
                        Stato Pianta
                    </h2>
                    <span id="plant-status-badge" class="status-badge status-ok">Sana</span>
                </div>
                
                <div class="plant-status">
                    <span class="material-icons-round plant-icon">spa</span>
                    <h3 class="plant-name" id="current-plant">Basilico Genovese</h3>
                    <p class="plant-variety" id="plant-variety">Ocimum basilicum</p>
                    
                    <div class="plant-health">
                        <span class="material-icons-round health-icon health-ok">mood</span>
                        <span id="plant-health-status">Stato di salute: Eccellente</span>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="plant-chart"></canvas>
                    </div>
                </div>
                
                <div class="issues-list" id="issues-list" style="display: none;">
                    <div class="issue-item">
                        <span class="material-icons-round issue-icon">warning</span>
                        <div>
                            <strong>Temperatura elevata</strong>
                            <p>La temperatura ha superato i 30¬∞C, attivare la ventilazione</p>
                        </div>
                    </div>
                </div>
                
                <h4 style="margin-top: 20px;">Seleziona Pianta</h4>
                <div class="plant-selection" id="plant-selection">
                    <!-- Popolato via JavaScript -->
                </div>
            </div>
            
            <!-- Controlli -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="material-icons-round">settings</span>
                        Controlli Automazione
                    </h2>
                </div>
                
                <div class="controls-grid">
                    <button class="control-btn" id="water-btn">
                        <span class="material-icons-round control-icon">water_drop</span>
                        <span class="control-label">Irrigazione</span>
                    </button>
                    
                    <button class="control-btn" id="fan-btn">
                        <span class="material-icons-round control-icon">air</span>
                        <span class="control-label">Ventilazione</span>
                    </button>
                    
                    <button class="control-btn" id="lights-btn">
                        <span class="material-icons-round control-icon">light_mode</span>
                        <span class="control-label">Luci LED</span>
                    </button>
                    
                    <button class="control-btn" id="shade-btn">
                        <span class="material-icons-round control-icon">filter_vintage</span>
                        <span class="control-label">Ombreggiatura</span>
                    </button>
                </div>
                
                <h4>Log Azioni Recenti</h4>
                <div class="action-log" id="action-log">
                    <div class="log-item">
                        <span class="log-time">10:45</span>
                        <span class="material-icons-round log-icon log-water">water_drop</span>
                        <span class="log-message">Irrigazione attivata per 5 minuti</span>
                    </div>
                    <div class="log-item">
                        <span class="log-time">09:30</span>
                        <span class="material-icons-round log-icon log-fan">air</span>
                        <span class="log-message">Ventilazione aumentata al 70%</span>
                    </div>
                    <div class="log-item">
                        <span class="log-time">07:00</span>
                        <span class="material-icons-round log-icon log-light">light_mode</span>
                        <span class="log-message">Luci LED accese</span>
                    </div>
                </div>
            </div>
            
            <!-- Chatbot Serra -->
            <div class="chatbot-container">
                <div class="chatbot-header">
                    <span class="material-icons-round chatbot-icon">psychology</span>
                    <h3 class="chatbot-title">Assistente Serra Intelligente</h3>
                </div>
                
                <div class="chatbot-messages" id="chatbot-messages">
                    <div class="message bot-message">
                        üåø Ciao! Sono la tua Serra Intelligente. Come posso aiutarti oggi? Posso darti consigli sulle tue piante, sull'ambiente della serra o sull'automazione dei sistemi!
                    </div>
                </div>
                
                <div class="chatbot-input">
                    <input type="text" id="chatbot-input" placeholder="Scrivi il tuo messaggio..." autocomplete="off">
                    <button id="chatbot-send">
                        <span class="material-icons-round">send</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Database delle piante
        const plantsDatabase = [
            {
                name: "Basilico Genovese",
                scientific: "Ocimum basilicum",
                type: "erba aromatica",
                temp: { min: 18, max: 28 },
                humidity: { min: 50, max: 70 },
                soil: { min: 60, max: 80 },
                light: { min: 6000, max: 12000 },
                water: "moderata",
                icon: "grass",
                description: "Il re delle erbe aromatiche italiane, perfetto per pesto e insalate."
            },
            {
                name: "Pomodoro San Marzano",
                scientific: "Solanum lycopersicum",
                type: "ortaggio",
                temp: { min: 20, max: 30 },
                humidity: { min: 50, max: 70 },
                soil: { min: 60, max: 80 },
                light: { min: 8000, max: 15000 },
                water: "abbondante",
                icon: "yard",
                description: "Il celebre pomodoro per sughi, richiede sostegni e potature."
            },
            {
                name: "Fragraria",
                scientific: "Fragaria √ó ananassa",
                type: "frutto",
                temp: { min: 15, max: 25 },
                humidity: { min: 60, max: 75 },
                soil: { min: 65, max: 85 },
                light: { min: 7000, max: 12000 },
                water: "regolare",
                icon: "local_florist",
                description: "Deliziose fragole che richiedono spazio per i corridori."
            },
            {
                name: "Rosmarino",
                scientific: "Salvia rosmarinus",
                type: "erba aromatica",
                temp: { min: 10, max: 30 },
                humidity: { min: 40, max: 60 },
                soil: { min: 40, max: 70 },
                light: { min: 7000, max: 14000 },
                water: "scarsa",
                icon: "filter_vintage",
                description: "Robusto e resistente, perfetto per arrosti e oli aromatici."
            },
            {
                name: "Lattuga Romana",
                scientific: "Lactuca sativa",
                type: "ortaggio",
                temp: { min: 12, max: 22 },
                humidity: { min: 60, max: 80 },
                soil: { min: 70, max: 90 },
                light: { min: 5000, max: 10000 },
                water: "abbondante",
                icon: "eco",
                description: "A crescita rapida, ideale per insalate fresche."
            },
            {
                name: "Menta Piperita",
                scientific: "Mentha √ó piperita",
                type: "erba aromatica",
                temp: { min: 15, max: 25 },
                humidity: { min: 60, max: 75 },
                soil: { min: 70, max: 90 },
                light: { min: 5000, max: 10000 },
                water: "abbondante",
                icon: "spa",
                description: "Invadente ma deliziosa per t√® e cocktail."
            },
            {
                name: "Peperoncino Calabrese",
                scientific: "Capsicum annuum",
                type: "ortaggio",
                temp: { min: 20, max: 32 },
                humidity: { min: 50, max: 70 },
                soil: { min: 60, max: 80 },
                light: { min: 9000, max: 15000 },
                water: "moderata",
                icon: "whatshot",
                description: "Piccante e vigoroso, ama il caldo e il sole."
            },
            {
                name: "Zucchino Nero",
                scientific: "Cucurbita pepo",
                type: "ortaggio",
                temp: { min: 18, max: 28 },
                humidity: { min: 60, max: 75 },
                soil: { min: 70, max: 90 },
                light: { min: 8000, max: 14000 },
                water: "abbondante",
                icon: "park",
                description: "Produttivo, richiede spazio per le grandi foglie."
            },
            {
                name: "Limone",
                scientific: "Citrus limon",
                type: "albero da frutto",
                temp: { min: 12, max: 28 },
                humidity: { min: 50, max: 70 },
                soil: { min: 60, max: 80 },
                light: { min: 10000, max: 15000 },
                water: "moderata",
                icon: "forest",
                description: "Alberello che necessita di potature e concimazioni regolari."
            },
            {
                name: "Melanzana Violetta",
                scientific: "Solanum melongena",
                type: "ortaggio",
                temp: { min: 20, max: 30 },
                humidity: { min: 55, max: 75 },
                soil: { min: 65, max: 85 },
                light: { min: 9000, max: 14000 },
                water: "regolare",
                icon: "emoji_nature",
                description: "Delicata ma gratificante, ottima per parmigiana e conserve."
            }
        ];

        // Configurazione
        const WEATHER_API_KEY = "3222d6d63ef2437780b182634250305";
        const GROQ_API_KEY = "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";
        const GROQ_MODEL = "meta-llama/llama-4-maverick-17b-128e-instruct";
        const LOCATION = "Belpasso";
        
        // Stato applicazione
        let currentPlant = plantsDatabase[0];
        let chatHistory = [
            {
                role: "system",
                content: "Tu sei una Serra Intelligente, parli solo italiano, sei gentile e dolce, aggiungi degli emoticon verdi, sei concisa e decisa. conosci ogni tipo di pianta e frutta in natura. Non puoi parlare di argomenti che escono troppo fuori dalla natura. Devi saperne di ventilazione per serre, temperatura, umidit√†, irrigazione, luci led eccetera eccetera, per non far seccare o ammalare il raccolto, √® importantissimo che tu faccia attenzione. Devi saperne anche di energia autogestita, di pannelli solari, inverter, batterie. Devi conoscere ogni caratteristica di frutta e verdura. Devi conoscere rarit√† e prezzi. E ricorda che sei la serra del tuo utente, ti devi occupare di tenere tutto pulito ed in funzione."
            }
        ];

        // Inizializzazione grafici
        const internalCtx = document.getElementById('internal-chart').getContext('2d');
        const plantCtx = document.getElementById('plant-chart').getContext('2d');
        
        const internalChart = new Chart(internalCtx, {
            type: 'line',
            data: {
                labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                datasets: [
                    {
                        label: 'Temperatura (¬∞C)',
                        data: Array.from({length: 24}, () => Math.floor(Math.random() * 5) + 22),
                        borderColor: '#F44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        tension: 0.3,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Umidit√† (%)',
                        data: Array.from({length: 24}, () => Math.floor(Math.random() * 20) + 50),
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        tension: 0.3,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Temperatura (¬∞C)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Umidit√† (%)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
        
        const plantChart = new Chart(plantCtx, {
            type: 'line',
            data: {
                labels: ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'],
                datasets: [
                    {
                        label: 'Condizioni Ideali',
                        data: [85, 85, 85, 85, 85, 85, 85],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        borderDash: [5, 5],
                        tension: 0.1
                    },
                    {
                        label: 'Condizioni Attuali',
                        data: [70, 72, 75, 78, 80, 82, 84],
                        borderColor: '#FF9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 50,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Indice Benessere'
                        }
                    }
                }
            }
        });
        
        // Popola selezione piante
        function populatePlantSelection() {
            const container = document.getElementById('plant-selection');
            container.innerHTML = plantsDatabase.map(plant => `
                <div class="plant-option ${plant.name === currentPlant.name ? 'selected' : ''}" 
                     data-name="${plant.name}" onclick="selectPlant('${plant.name}')">
                    <span class="material-icons-round plant-option-icon">${plant.icon}</span>
                    <h4>${plant.name}</h4>
                    <p>${plant.type}</p>
                </div>
            `).join('');
        }
        
        // Seleziona pianta
        function selectPlant(plantName) {
            currentPlant = plantsDatabase.find(p => p.name === plantName);
            document.getElementById('current-plant').textContent = currentPlant.name;
            document.getElementById('plant-variety').textContent = currentPlant.scientific;
            
            // Aggiorna grafico pianta con dati casuali
            plantChart.data.datasets[1].data = Array.from({length: 7}, () => 
                Math.floor(Math.random() * 15) + 70
            );
            plantChart.update();
            
            // Aggiorna selezione
            document.querySelectorAll('.plant-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.name === plantName);
            });
            
            // Aggiungi messaggio al chatbot
            addBotMessage(`üå± Ho cambiato la pianta in ${currentPlant.name}. ${currentPlant.description} 
                Ricorda che preferisce temperature tra ${currentPlant.temp.min}¬∞C e ${currentPlant.temp.max}¬∞C 
                e umidit√† del terreno tra ${currentPlant.soil.min}% e ${currentPlant.soil.max}%.`);
        }
        
        // Popola previsioni meteo
        async function fetchWeatherData() {
            try {
                // Usa un proxy CORS per evitare problemi
                const proxyUrl = 'https://api.allorigins.win/get?url=';
                const apiUrl = `http://api.weatherapi.com/v1/forecast.json?key=${WEATHER_API_KEY}&q=${LOCATION}&days=3&lang=it`;
                
                const response = await fetch(proxyUrl + encodeURIComponent(apiUrl));
                const data = await response.json();
                
                if (data.contents) {
                    const weatherData = JSON.parse(data.contents);
                    updateWeatherUI(weatherData);
                } else {
                    console.error("Dati meteo non ricevuti:", data);
                    // Usa dati simulati in caso di errore
                    simulateWeatherData();
                }
            } catch (error) {
                console.error("Errore nel recupero dati meteo:", error);
                simulateWeatherData();
            }
        }
        
        function updateWeatherUI(weatherData) {
            const current = weatherData.current;
            const forecast = weatherData.forecast.forecastday[0];
            
            // Aggiorna dati correnti
            document.getElementById('current-temp').textContent = `${current.temp_c}¬∞C`;
            document.getElementById('weather-desc').textContent = current.condition.text;
            document.getElementById('weather-humidity').textContent = `${current.humidity}%`;
            document.getElementById('weather-wind').textContent = `${current.wind_kph} km/h`;
            document.getElementById('weather-rain').textContent = forecast.day.daily_chance_of_rain > 0 ? 
                `${forecast.day.daily_chance_of_rain}%` : '0 mm';
            
            // Aggiorna stato esterno
            const externalStatus = document.getElementById('external-status');
            if (forecast.day.daily_chance_of_rain > 50) {
                externalStatus.textContent = "Pioggia";
                externalStatus.className = "status-badge status-warning";
            } else if (current.temp_c > 30) {
                externalStatus.textContent = "Caldo";
                externalStatus.className = "status-badge status-danger";
            } else {
                externalStatus.textContent = "Sereno";
                externalStatus.className = "status-badge status-ok";
            }
            
            // Aggiorna previsioni orarie
            const hourlyContainer = document.getElementById('hourly-forecast');
            hourlyContainer.innerHTML = forecast.hour.slice(0, 12).map(hour => {
                const time = new Date(hour.time);
                return `
                    <div class="hourly-item">
                        <p><strong>${time.getHours()}:00</strong></p>
                        <p>${hour.temp_c}¬∞C</p>
                        <p>üíß ${hour.humidity}%</p>
                        ${hour.chance_of_rain > 0 ? `<p>‚òî ${hour.chance_of_rain}%</p>` : ''}
                    </div>
                `;
            }).join('');
            
            // Aggiorna previsioni giornaliere
            const dailyContainer = document.getElementById('daily-forecast');
            dailyContainer.innerHTML = weatherData.forecast.forecastday.map(day => {
                const date = new Date(day.date);
                const dayNames = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
                return `
                    <div class="daily-item">
                        <p><strong>${dayNames[date.getDay()]}</strong></p>
                        <p>${day.day.maxtemp_c}¬∞C</p>
                        <p>${day.day.mintemp_c}¬∞C üåô</p>
                        <p>üíß ${day.day.avghumidity}%</p>
                    </div>
                `;
            }).join('');
        }
        
        function simulateWeatherData() {
            // Dati simulati per quando l'API non funziona
            document.getElementById('current-temp').textContent = `${Math.floor(Math.random() * 10) + 20}¬∞C`;
            document.getElementById('weather-desc').textContent = "Sereno";
            document.getElementById('weather-humidity').textContent = `${Math.floor(Math.random() * 30) + 50}%`;
            document.getElementById('weather-wind').textContent = `${Math.floor(Math.random() * 20)} km/h`;
            document.getElementById('weather-rain').textContent = "0 mm";
            
            const hourlyContainer = document.getElementById('hourly-forecast');
            hourlyContainer.innerHTML = Array.from({length: 12}, (_, i) => {
                const hour = new Date();
                hour.setHours(hour.getHours() + i);
                return `
                    <div class="hourly-item">
                        <p><strong>${hour.getHours()}:00</strong></p>
                        <p>${Math.floor(Math.random() * 5) + 22}¬∞C</p>
                        <p>üíß ${Math.floor(Math.random() * 20) + 50}%</p>
                    </div>
                `;
            }).join('');
            
            const dailyContainer = document.getElementById('daily-forecast');
            dailyContainer.innerHTML = Array.from({length: 3}, (_, i) => {
                const day = new Date();
                day.setDate(day.getDate() + i);
                const dayNames = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
                return `
                    <div class="daily-item">
                        <p><strong>${dayNames[day.getDay()]}</strong></p>
                        <p>${Math.floor(Math.random() * 5) + 22}¬∞C</p>
                        <p>${Math.floor(Math.random() * 5) + 16}¬∞C üåô</p>
                        <p>üíß ${Math.floor(Math.random() * 20) + 50}%</p>
                    </div>
                `;
            }).join('');
        }
        
        // Gestione chatbot
        document.getElementById('chatbot-send').addEventListener('click', sendMessage);
        document.getElementById('chatbot-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        function addBotMessage(message) {
            const messagesContainer = document.getElementById('chatbot-messages');
            messagesContainer.innerHTML += `
                <div class="message bot-message">
                    ${message}
                </div>
            `;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatbot-input');
            const message = input.value.trim();
            if (!message) return;
            
            const messagesContainer = document.getElementById('chatbot-messages');
            
            // Aggiungi messaggio utente
            messagesContainer.innerHTML += `
                <div class="message user-message">
                    ${message}
                </div>
            `;
            
            input.value = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Aggiungi al contesto
            chatHistory.push({ role: "user", content: message });
            
            // Mostra indicatori di caricamento
            const loadingId = 'loading-' + Date.now();
            messagesContainer.innerHTML += `
                <div id="${loadingId}" class="message bot-message">
                    <span style="display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(0,0,0,.3); border-radius: 50%; border-top-color: #4CAF50; animation: spin 1s ease-in-out infinite; margin-right: 10px;"></span>
                    Sto pensando...
                </div>
            `;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            try {
                // Chiamata API Groq
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: GROQ_MODEL,
                        messages: chatHistory,
                        temperature: 0.7,
                        max_tokens: 500
                    })
                });
                
                const data = await response.json();
                const botResponse = data.choices[0].message.content;
                
                // Aggiungi al contesto
                chatHistory.push({ role: "assistant", content: botResponse });
                
                // Sostituisci il messaggio di caricamento con la risposta
                document.getElementById(loadingId).outerHTML = `
                    <div class="message bot-message">
                        ${botResponse}
                    </div>
                `;
                
            } catch (error) {
                console.error("Errore chatbot:", error);
                document.getElementById(loadingId).outerHTML = `
                    <div class="message bot-message">
                        ‚ö†Ô∏è Mi dispiace, al momento non posso rispondere. Prova pi√π tardi o contattami su Telegram.
                    </div>
                `;
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Simula dati sensori in tempo reale
        function simulateSensorData() {
            setInterval(() => {
                const temp = (Math.random() * 2 + 23.5).toFixed(1);
                const humidity = Math.floor(Math.random() * 10 + 60);
                const soil = Math.floor(Math.random() * 10 + 65);
                const light = Math.floor(Math.random() * 2000 + 7000);
                
                document.getElementById('internal-temp').textContent = temp;
                document.getElementById('internal-humidity').textContent = humidity;
                document.getElementById('internal-soil').textContent = soil;
                document.getElementById('internal-light').textContent = light;
                
                // Aggiorna stato interno
                const statusElement = document.getElementById('internal-status');
                if (temp > currentPlant.temp.max || temp < currentPlant.temp.min) {
                    statusElement.textContent = "Attenzione";
                    statusElement.className = "status-badge status-warning";
                } else if (soil < currentPlant.soil.min) {
                    statusElement.textContent = "Irrigare";
                    statusElement.className = "status-badge status-danger";
                } else {
                    statusElement.textContent = "Ottimale";
                    statusElement.className = "status-badge status-ok";
                }
                
                // Aggiorna grafico con nuovi dati
                internalChart.data.datasets[0].data.shift();
                internalChart.data.datasets[0].data.push(temp);
                internalChart.data.datasets[1].data.shift();
                internalChart.data.datasets[1].data.push(humidity);
                internalChart.update();
                
            }, 5000);
        }
        
        // Inizializzazione
        document.addEventListener('DOMContentLoaded', () => {
            populatePlantSelection();
            fetchWeatherData();
            simulateSensorData();
            
            // Aggiungi messaggio iniziale del chatbot con info sulla pianta
            addBotMessage(`üå± Attualmente stai coltivando ${currentPlant.name}. ${currentPlant.description} 
                Ricorda che preferisce temperature tra ${currentPlant.temp.min}¬∞C e ${currentPlant.temp.max}¬∞C 
                e umidit√† del terreno tra ${currentPlant.soil.min}% e ${currentPlant.soil.max}%.`);
        });

        // Esponi funzioni globali
        window.selectPlant = selectPlant;
    </script>
</body>
</html>
